---
title: "Capstone 454"
author: "Tina Chen, Kyle Suelflow, Samina Stack"
date: "`r format(Sys.Date(),'%e %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  collapse = TRUE, 
  warning = FALSE,
  message = FALSE,
  fig.height = 2.75, 
  fig.width = 4.25,
  fig.align = 'center')

library(dplyr)
library(tidyverse)
library(sf)
library(readxl)
```

## Research goals

- What methodology are you exploring? 
  * CAR (ICAR) (special case of the Leroux model)
  * BYM (further exploration if we have time)
- What is the motivation / goal behind this methodology? When is it useful?
  * We want to explore how correlated data (Specifically spatial data) and bayesian statistics are connected.
  * This dataset aggregates data in 1 degree latitude by 1 degree longitude cells, as this is the geographic unit for which information such as population data is very complete. It also introduces the measure gross cell product, demonstrating an aggregation measure for economic activity that does not rely on political boundaries.


## Resources
- What resources (eg: books, blogs, articles) are you using to get started?
  * Data resources: SEDAC NASA EOSDIS geographically gridded economic data (our dataset)
  * Class Notes from Correlated Data https://bcheggeseth.github.io/CorrelatedData/areal-data.html
  * Walk through an example hierarchical ICAR model, using both notation and R code. https://atlas.cancer.org.au/developing-a-cancer-atlas/Chapter_4.html
  
- How do you plan to implement this methodology in R? For example, what packages might be useful? If none exist, whatâ€™s your implementation plan?
  * Method r package: Intrinsic Conditional Auto-Regressive (ICAR) models. https://mc-stan.org/users/documentation/case-studies/icar_stan.html







## Methodology background

#### About Areal Data and neightborhood structure
Areal data differs from point data, which consists of measurements from a known set of geo-spatial points. The boundary of areas can be considered polygons determined by a closed sequence of ordered coordinates connected by straight line segments. 

For a set of $N$ areal units, the relationship between areal units is described by an $n \times n$ adjacency matrix $W$. The entries indicate whether two regions $n_i$ and $n_j$ are neighbors, with a value of 1 signifying adjacency and 0 indicating non-adjacency. It's worth noting that in models like Conditional Autoregressive (CAR) models, the neighbor relationship is symmetric, but a region is not considered its own neighbor ($W_{ii} = 0$).

  * I see some inconsistency notations (adjacency matrix $A$ and weighted adjacency matrix $W$) used in the r package; I will check it later.
  
  
#### Model: Conditional Autoregressive (CAR) Models


$\phi$, an n-length vector $\phi = (\phi_1, ..., \phi_n)^T$, is the spatial random variables that can represent spatial interactions between $n_i$ and $n_j$.

In the full conditional distribution, each $\phi_i$ is conditional on the sum of the weighted values of its neighbors $(w_{ij} \phi_j)$ and has unknown variance. 

 \begin{split}
 
 \phi_i | \phi_j ,j \neq i, 
 &\sim N (\sum\limits_{j=1}^n w_{ij} \phi_j, \sigma^2)\\ 
 \phi &\sim N(0, Q^{-1})\\
 Q &= [D_{\tau}(I - \alpha B)]
 
 \end{split}

 
Where $W$ is the $n \times n$ adjacency matrix where entries $\{i,i\}$ are zero and the off-diagonal elements are 1 if regions $i$ and $j$ are neighbors and 0.

$D$ is the $n \times n$ diagonal matrix where entries $\{i,i\}$ are the number of neighbors of region $i$ and the off-diagonal entries are 0.

$D_{\tau} = \tau D$

$\alpha$ controls the amount of spatial correlation; $\alpha = 0$ implies spatial independence and $\alpha = 1$ implies complete spatial correlation. 

$B$ is the scaled adjacency matrix $D^{-1}W$

$I$ is an $n \times n$ identity matrix
 

 

#### Assumption


An Intrinsic Conditional Auto-Regressive (ICAR) model is a CAR model where $\alpha=1$
, that is, it assumes complete spatial correlation between regions. (This assumption is problematic). The joint distribution of the ICAR model is derived from the joint distribution for the CAR model as follows:

$$
 \phi \sim N(0, [\tau(D-W)]^{-1})\\
$$
The resulting matrix $[\tau(D-W)]$ is singular, thus the ICAR variate $\phi$ is an improper prior distribution. But it still can be used as a prior part of a hierarchical model.

  - since $D_\tau = \tau D$ and $B = D^{-1}W$, the expression $[D_{\tau}(I -\alpha B)]$ simplifies to $[\tau(D-\alpha W)]$
  - since $\alpha = 1$, it is omitted.

### Data

#### Data collection

> Introductory:
We are considering using geographically gridded economic data for the years 1990, 1995, and 2000, which was collected by the G-Econ Project at Yale University and published by the NASA Socieconomic Data and Applications Center (SEDAC). It was collected with the intent of examining the geographic attributes of economic activity. Economic activity is often clustered geographically, in major cities and along coastlines.  

#### Data codebook


```{r}
code_book <- read_excel("Gecon40_post_final.xls", sheet = "definitions")

code_book[c(2,3,4,5,7,8,9,13,14,16,20,25,29,30,34,35,41,44,46),]

```




#### Data summaries


```{r}
data_demo <- read_excel("Gecon40_post_final.xls")
dim(data_demo)
names(data_demo) # need code book 
head(data_demo)

# number of countries in the dataset
data_demo %>% count(COUNTRY) %>% nrow()
```
#### Visualization


```{r}
data_demo %>% filter( POPGPW_2005_40 !=0) %>% 
ggplot(aes(x=POPGPW_2005_40))+
  geom_density()
```
  
  * Note: POPGPW_2005_40	is Grid cell population, 2005. This is a count variables, need to be logged to make sure data can live from 0 to infinity. 

```{r , fig.width = 7, fig.height = 5}
# world map

points_sf <- data_demo %>%
  st_as_sf(coords = c("LONGITUDE", "LAT"), crs = 4326)

# Expand each point to cover a 1x1 degree grid
expanded_grid <- st_make_grid(points_sf, cellsize = c(1, 1))

index <- which(lengths(st_intersects(expanded_grid, points_sf)) > 0)

# Filter out only the intersecting grid cells
fishnet <- expanded_grid[index]

# Convert the grid cells to sf, create unique IDs, and join with points
joined_data <- fishnet %>%
  st_as_sf() %>%
  mutate(grid_id = row_number()) %>%
  st_join(points_sf)


ggplot() +
  geom_sf(data = fishnet, fill = NA, color = "black") +
  geom_sf(data = joined_data,
          aes(fill = log(POPGPW_2005_40)), color = NA) +
  theme_classic()+
  theme(legend.title = element_text(size = 10),
               legend.text = element_text(size = 10))+
  labs(fill = "log(Grid cell\n population in 2005)")

```



```{r , fig.width = 7, fig.height = 5}
# only US focus
points_sf <- data_demo %>% filter(COUNTRY == "United States") %>% 
  st_as_sf(coords = c("LONGITUDE", "LAT"), crs = 4326)

# Expand each point to cover a 1x1 degree grid
expanded_grid <- st_make_grid(points_sf, cellsize = c(1, 1))

index <- which(lengths(st_intersects(expanded_grid, points_sf)) > 0)

# Filter out only the intersecting grid cells
fishnet <- expanded_grid[index]

# Convert the grid cells to sf, create unique IDs, and join with points
joined_data <- fishnet %>%
  st_as_sf() %>%
  mutate(grid_id = row_number()) %>%
  st_join(points_sf)


ggplot() +
  geom_sf(data = fishnet, fill = NA, color = "black") +
  geom_sf(data = joined_data,
          aes(fill = log(POPGPW_2005_40)), color = NA) +
  theme_classic()+
  theme(legend.title = element_text(size = 10),
               legend.text = element_text(size = 10))+
  labs(fill = "log(Grid cell\n population in 2005)")+
  coord_sf(xlim = c(-125, -70),ylim = c(22, 52))+
scale_fill_gradient(low = "blue", high = "orange")
```

  * to do: tweak the parameters for prior (hierarchical model)

